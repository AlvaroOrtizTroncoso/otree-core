{% extends "otree/admin/Session.html" %}
{% block content %}
{{ block.super }}
<script>
$(function () {
    $('#advance_users').on('click', function () {
        $.ajax({
            url: '{% url 'session_advance' session.pk %}',
            type: 'GET',
            error: function(jqXHR, textStatus) {
                $( "form" ).append('\
                    <div class="alert alert-danger"> <a href="#" class="close" data-dismiss="alert">&times;</a>\
                        "Server error, failed to advance users."\
                    </div>\
                ')
            },
            success: function (new_json) {
                ajax_json_participants();
            }
        });

    });
});
$(document).ready(
    function() {
        ajax_json_participants();
        setInterval(ajax_json_participants , 2000);
    }
);
function ajax_json_participants() {
    $.ajax({
        url: '{% url "session_participants_list" session.code %}',
        type: 'GET',
        error: function(jqXHR, textStatus) {
            $( "form" ).append('\
                <div class="alert alert-danger"> <a href="#" class="close" data-dismiss="alert">&times;</a>\
                    "Failed to update from the server"\
                </div>\
            ')
        },
        success: function (new_json) {
            var old_json = $( "table" ).data("raw");
            // build table for the first time
            if ( old_json === undefined ) {
                var htmlTable = ConvertJsonToTable(new_json,
                    "",
                    "header-fixed table table-bordered table-hover table-condensed");
                $("#div-table").append(htmlTable);
            }
            // compute delta and update
            // corresponding values in table 
            else {
                var diffpatcher = jsondiffpatch.create({
                    objectHash: function(obj) {
                        return obj.code;
                    }
                });
                var delta = diffpatcher.diff(old_json, new_json);
                for (i in delta) {
                    for (header_name in delta[i]) {
                        var header_index = $( "th" ).index($( "th#" + header_name ));
                        var cell_to_update = $( "tbody tr:eq(" + i + ") td:eq(" + header_index + ")" );
                        cell_to_update.text(delta[i][header_name][1]);
                        cell_to_update.css('background-color', 'green');
                        cell_to_update.animate({
                                backgroundColor: "white"
                            },
                            5000
                        );
                    }
                }
            }
            $( "table" ).data("raw", new_json);
        }
    });
}
</script>
<div style="overflow: auto" id="div-table">
</div>
<br/>
<a id="advance_users" class="btn btn-primary" role="button" data-toggle="popover" data-trigger="hover"
data-content="By clicking this button the slowest user(s)
will be automatically advanced by one page, while the other users
will remain where they are (unless perhaps if they have a waiting page).">
Advance slowest user(s)
</a>
{% include "otree/messages.html" %}
{% endblock %}
